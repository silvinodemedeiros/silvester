
<div
  [ngClass]="{
    'layout': true,
    'layout-preview': gridPreview
  }"
  (dragover)="onDragOver($event, -1, -1)"
  (drop)="onDrop($event, -1, -1)"
>
    <header
      *ngIf="!gridPreview"
      class="topbar"
    >
      <div class="menu-item menu-item-button menu-item-button-header" (click)="gridPreview = !gridPreview">
        <ng-icon name="bootstrapEye"></ng-icon>
        Preview
      </div>
      <div class="menu-item menu-item-button menu-item-button-header" (click)="gridPreview = !gridPreview">
        <ng-icon name="bootstrapMoonStarsFill"></ng-icon>
        Dark Mode
      </div>
      <div class="menu-item menu-item-button menu-item-button-header" (click)="gridPreview = !gridPreview">
        <ng-icon name="bootstrapEyeglasses"></ng-icon>
        High Contrast
      </div>
      <div style="margin-left: auto;"></div>
      <div class="menu-item menu-item-button menu-item-button-header" (click)="isCreatingWidget = !isCreatingWidget">
        <ng-icon name="bootstrapPlus"></ng-icon>
        Create Widget
      </div>
    </header>

    <!-- SIDEBAR -->
    <aside
      *ngIf="!gridPreview"
      class="sidebar"
    >
      @for (menuItem of menuItems(); track menuItem.item.id) {
        <div
          class="menu-item"
          draggable="true"
          (dragstart)="onDragStart($event, menuItem)"
        >
          <ng-icon [name]="menuItem.data.metadata?.icon?.value"></ng-icon>
          {{ menuItem.item.label }}
        </div>
      }
      <div class="divider"></div>
      <div
        class="menu-item menu-item-button"
        (click)="exportGrid()"
      >
        Export Grid
      </div>
      <div
        class="menu-item menu-item-button"
        (click)="importGrid()"
      >
        Import Grid
      </div>
    </aside>

    <!--# GRID #-->
    <main
      [ngClass]="{
        'content': true,
        'content-preview': gridPreview,
        'content-edit': isEditingWidget
      }"
      role="main"
    >
      <div class="grid">

        <!--# CELLS LAYER #-->
        <div
          *ngFor="let cell of cells"
          [ngClass]="{
            'cell': true,
            'has-widget-preview': previewWidget && hasPreview(cell.row, cell.col),
            'has-grid-preview': gridPreview,
            'is-creating-widget': isCreatingWidget
          }"
          (dragover)="onDragOver($event, cell.row, cell.col)"
          (dragleave)="onDragLeave()"
          (drop)="onDrop($event, cell.row, cell.col)"
          (click)="handleCellClick($event, cell.row, cell.col)"
        ></div>

        <!--# WIDGETS LAYER #-->
        <div class="grid-widgets-wrapper" *ngIf="!(isDragging || isCreatingWidget)">
          <ng-container
            *ngFor="let gridWidget of gridWidgets()"
          >
            <div
              class="grid-widget cell monochromatic"
              [ngClass]="{
                'grid-widget-map': gridWidget.data.type == 'Location',
                'grid-widget-has-preview': gridPreview,
                'grid-widget-selected': previousWidget?.item?.id == gridWidget.item.id
              }"
              [ngStyle]="{
                'grid-area': (gridWidget.row + 1) + '/' + (gridWidget.col + 1) + '/ span ' + gridWidget.item.height + '/ span ' + gridWidget.item.width
              }"
              (dragstart)="onDragStart($event, gridWidget, true)"
              [tabIndex]="1"
            >
            
              <p class="grid-widget-title">
                {{ gridWidget.data.metadata?.title?.value }}
              </p>

              <!-- # WIDGET DIFFERENTIATION # -->
              @if (gridWidget.data.type == 'location') {
                <app-map-widget
                  [ngClass]="'grid-widget-map-wrapper'"
                  [data]="gridWidget"
                  [has-preview]="gridPreview"
                ></app-map-widget>
              } @else {
                <span class="grid-widget-value">
                  {{ gridWidget | widgetValue }}
                  <span class="grid-widget-value-suffix">
                    {{ gridWidget.data.metadata?.measures?.value | widgetSuffix }}
                  </span>
                </span>
              }

              <p class="grid-widget-icon">
                <ng-icon [name]="gridWidget.data.metadata?.icon?.value"></ng-icon>
              </p>
              
              <div
                *ngIf="!gridPreview"
                [ngClass]="{
                  'drag-handle': true
                }"
                (mousedown)="handleOnMouseDown($event)"
                (mouseup)="handleOnMouseUp($event)"
              ></div>
              
              <div
                [ngClass]="{
                  'edit-handle': true
                }"
                (mousedown)="toggleWidgetEdit(gridWidget)"
              >
                <ng-icon
                  [name]="
                    previousWidget?.item?.id == gridWidget.item.id
                    ? 'bootstrapX'
                    : 'bootstrapPencil'
                  "
                ></ng-icon>
              </div>
            </div>
          </ng-container>
        </div>

        <!--# UPLOADER LAYER #-->
        <div
          *ngIf="isDraggingFile"
          class="uploader-wrapper"
          (dragover)="onUploadDragOver()"
          (dragleave)="onUploadDragLeave()"
          (drop)="onUploadDrop($event)"
        >
          <h1>Drop your JSON file here</h1>
        </div>
      </div>

      @if (isEditingWidget) {
        <div class="config-panel-wrapper">

          <div class="config-panel">

            <div class="config-panel-header">
              <span class="title">Editing widget - {{ previousWidget?.data?.metadata?.title?.value }}</span>
            </div>

            <div class="config-panel-form">

              <div class="config-panel-form-content" [formGroup]="editForm">
                <mat-form-field appearance="outline">
                  <mat-label>Widget Title</mat-label>
                  <input matInput formControlName="title"/>
                </mat-form-field>
                
                <mat-form-field appearance="outline">
                  <mat-label>Icon Name</mat-label>
                  <mat-select formControlName="icon">
                    @for(icon of iconList; track icon.id) {
                      <mat-option [value]="icon.value">{{icon.name}}</mat-option>
                    }
                  </mat-select>
                </mat-form-field>
                
                <mat-form-field appearance="outline">
                  <mat-label>Measurement</mat-label>
                  <mat-select formControlName="measures">
                    @for(measures of measurementsList; track measures.id) {
                      <mat-option [value]="measures.value">{{measures.title}}</mat-option>
                    }
                  </mat-select>
                </mat-form-field>
                
                <mat-form-field appearance="outline">
                  <mat-label>Data Source</mat-label>
                  <mat-select formControlName="weatherType">
                    @for(weather of weatherList; track weather.id) {
                      <mat-option [value]="weather.value">{{weather.name}}</mat-option>
                    }
                  </mat-select>
                </mat-form-field>
              </div>
            </div>

            <div class="config-panel-actions">
              
              <div class="menu-item menu-item-button menu-item-button-header">
                <ng-icon name="bootstrapCheck"></ng-icon>
                Update Widget
              </div>
              
              <div class="menu-item menu-item-button menu-item-button-header">
                <ng-icon name="bootstrapSave"></ng-icon>
                Save as Template
              </div>
            </div>
          </div>
        </div>
      }
    </main>
</div>

